- DOM 树和 CSSOM 树合并成渲染树
- 渲染树只包含渲染网页所需的节点
- 布局计算每个对象的精确位置和大小
- 绘制，使用最终渲染树将像素渲染到屏幕上

### 合并渲染树

&emsp;&emsp;第一步是浏览器将 DOM 和 CSSOM 合并成一个“渲染树”，网罗网页上所有可见的 DOM 内容，以及每个节点的所有 CSSOM 样式信息。

![render-tree-construction.png](./img/render-tree-construction.png)

&emsp;&emsp;构建渲染树过程中，浏览器工作主要是：

1. 从 DOM 树的根节点开始遍历每个可见节点。

   - 某些节点不可见（例如脚本标记、元标记），因为它们不会体现在渲染输出中，所以会被忽略。
   - 某些节点通过 CSS 隐藏，因此在渲染树中也会被忽略，例如，在节点上设置了“display: none”属性。

2. 对于每个可见节点，为其找到适配的 CSSOM 规则并应用它们。

   visibility: hidden 与 display: none 是不一样的。前者隐藏元素，但元素仍占据着布局空间（即将其渲染成一个空框），而后者 (display: none) 将元素从渲染树中完全移除，元素既不可见，也不是布局的组成部分。

3. 发射可见节点，连同其内容和计算的样式。

&emsp;&emsp;最终输出的渲染同时包含了屏幕上的所有可见内容及其样式信息。

### 布局

&emsp;&emsp;有了渲染树，就可以进入“布局”阶段。开始计算各节点在设备视口内的确切位置和大小。

&emsp;&emsp;布局流程输出一个“盒模型”，会精确地捕获每个元素在视口内的确切位置和尺寸。所有相对测量值都转换为屏幕上的绝对像素。

### 绘制（栅格化）

&emsp;&emsp;得到各节点的样式以及几何信息后，将渲染树中的每个节点转换成屏幕上的实际像素。

&emsp;&emsp;“Layout”事件在时间线中捕获渲染树构建以及位置和尺寸计算。

&emsp;&emsp;布局完成后，浏览器会立即发出“Paint Setup”和“Paint”事件，将渲染树转换成屏幕上的像素。

### 总结

&emsp;&emsp;执行渲染树构建、布局和绘制所需的时间将取决于文档大小、应用的样式，以及运行文档的设备: 文档越大，浏览器需要完成的工作就越多；样式越复杂，绘制需要的时间就越长（例如，单色的绘制开销“较小”，而阴影的计算和渲染开销则要“大得多”）。
